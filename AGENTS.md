# AGENTS.md for org-sass Codebase

## Architecture Overview

**org-sass** is a Turborepo monorepo combining a web frontend, WeChat mini program, and documentation site with a shared API layer.

- **Apps**: `web` (TanStack Start + React), `mini` (WeChat mini program), `fumadocs` (docs)
- **Packages**: `api` (oRPC type-safe backend), `auth` (Better-Auth), `db` (Drizzle ORM), `env`, `config`

### Data Flow

1. **Web Frontend** → calls oRPC client → `/api/rpc` endpoint
2. **oRPC Server** (in `@org-sass/api`) → authenticates via Better-Auth → queries database via Drizzle
3. **Database**: PostgreSQL with Drizzle schema in `packages/db/src/schema/`
4. **Authentication**: Better-Auth handles session + credentials, stored in Drizzle DB

## Critical Workflows

### Development

```bash
bun run dev              # Run all apps (web, mini, docs) in watch mode
bun run dev:web         # Web only (port 3001)
bun run check           # Format and lint all files with Biome (required before commit)
```

### Database

```bash
bun run db:push         # Apply schema changes to database
bun run db:studio       # GUI database editor at http://localhost:5555
bun run db:generate     # Generate schema types from SQL
bun run db:migrate      # Create migration files
```

### Building & Type Checking

```bash
bun run build           # Build all packages
bun run check-types     # Type check all packages
```

## Key Patterns & Conventions

### API Routes (oRPC)

All API handlers live in `packages/api/src/routers/`. Use middleware-based procedure composition:

```typescript
// `publicProcedure` - no auth required
publicProcedure.handler(() => "OK")

// `protectedProcedure` - requires authenticated session
protectedProcedure.handler(({ context }) => {
  return { user: context.session?.user };
})
```

**Important**: Router handlers are **isomorphic** - same code runs on server (SSR) and client (API calls).

### Authentication Context

Session is extracted in `packages/api/src/context.ts` via `auth.api.getSession()`. Always use `context.session` to check if user is authenticated.

### Admin & Organization Plugins

Better-Auth provides powerful plugins for managing component architecture roles and permissions:

- **Admin Plugin** - Manages admin users and elevated permissions within the system
- **Organization Plugin** - Manages multi-tenant organizations, teams, members, and hierarchies
- **Role-based Access Control (RBAC)** - Define custom roles and permissions for organizational structures
- **Configuration**: Plugins are configured in `packages/auth/src/index.ts` when initializing Better-Auth
- **Database Schema**: Both plugins auto-generate required database tables; use `bun run db:push` to apply schema changes
- **Usage Pattern**: Access organization and admin context via `context.session?.user` in protected procedures to enforce role-based authorization

### Database Schema

- Schemas live in `packages/db/src/schema/`
- Auth tables auto-generated by Better-Auth
- Use Drizzle relations for type-safe queries
- Push changes: `bun run db:push`

### Web Frontend Routing

TanStack Router with file-based route generation:

- Routes: `apps/web/src/routes/` (suffix `.tsx` auto-registered)
- Each route file exports `Route` from `createRootRouteWithContext<RouterAppContext>`
- Access oRPC client: `useContext(RouterAppContext).orpc`
- Client-side queries use `@orpc/tanstack-query` hooks

### Code Style & Formatting

- **Formatter**: Biome (tabs, 2-space indents)
- **Linter**: Biome with recommended rules + custom class sorting (`clsx`, `cva`, `cn`)
- **Ignored files**: Biome skips `routeTree.gen.ts`, `.next`, `dist`, generated components
- **Pre-commit hook**: Lefthook auto-formats staged files with `biome check --write`

## Package Workspaces & Exports

Use workspace paths for internal imports:

```typescript
import { appRouter } from "@org-sass/api/routers/index";
import { db } from "@org-sass/db";
import { auth } from "@org-sass/auth";
```

Each package exports via `exports` field in `package.json`. Follow the pattern.

## WeChat Mini Program

- Located at `apps/mini/`
- Uses TDesign component library (`tdesign-miniprogram`)
- Custom tab bar in `custom-tab-bar/index.wxml`
- Pages: `pages/index/` and `pages/logs/`
- Uses Skyline renderer with Glass-Easel component framework

## Tools & Stack

- **Package manager**: bun@1.3.6
- **Build system**: Turborepo (config in `turbo.json`)
- **Monorepo caching**: Enabled for `build`, `check-types` tasks
- **Database ORM**: Drizzle with PostgreSQL
- **Auth**: Better-Auth with Drizzle adapter
- **RPC Framework**: oRPC with Zod validation
- **UI Framework**: React with TailwindCSS + shadcn/ui
- **Router**: TanStack Router with TanStack Start (SSR)
- **State**: TanStack Query (React Query)
- **Styling**: TailwindCSS + CVA

## Common Pitfalls

1. **Don't modify `routeTree.gen.ts`** - auto-generated by TanStack Router
2. **Biome imports organization** - auto-fixed by `bun run check`
3. **API changes** - update routers in `packages/api/src/routers/`, types flow automatically to client
4. **DB migrations** - always use `bun run db:push` to track schema in git
5. **CORS** - configured via `env.CORS_ORIGIN`, update in `.env` files
