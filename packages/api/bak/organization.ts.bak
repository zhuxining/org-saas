import { auth } from "@org-sass/auth";
import { getLogger } from "@orpc/experimental-pino";
import { z } from "zod";

import { protectedProcedure } from "../index";
import { mapAuthErrorToORPC } from "../lib/error-handler";

export const organizationRouter = {
	// Organization Management logic
	createOrganization: protectedProcedure
		.input(
			z.object({
				name: z.string(),
				slug: z.string(),
				logo: z.string().optional(),
				metadata: z.record(z.string(), z.unknown()).optional(),
				userId: z.string().optional(),
				keepCurrentActiveOrganization: z.boolean().optional().default(false),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);
			try {
				const result = await auth.api.createOrganization({
					body: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "CREATE_ORGANIZATION",
						organizationSlug: input.slug,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to create organization",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	checkOrganizationSlug: protectedProcedure
		.input(
			z.object({
				slug: z.string(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.checkOrganizationSlug({
					body: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "CHECK_ORGANIZATION_SLUG",
						slug: input.slug,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to check organization slug",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	listOrganizations: protectedProcedure.handler(async ({ context }) => {
		const logger = getLogger(context);

		try {
			const result = await auth.api.listOrganizations({
				headers: context.headers as Headers,
			});
			return result;
		} catch (error) {
			logger?.error(
				{
					userId: context.session.user.id,
					action: "LIST_ORGANIZATIONS",
					error: error instanceof Error ? error.message : "Unknown error",
				},
				"Failed to list organizations",
			);
			throw mapAuthErrorToORPC(error);
		}
	}),

	getFullOrganization: protectedProcedure
		.input(
			z.object({
				organizationId: z.string().optional(),
				organizationSlug: z.string().optional(),
				membersLimit: z.number().optional().default(100),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.getFullOrganization({
					query: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "GET_ORGANIZATION",
						organizationId: input.organizationId,
						organizationSlug: input.organizationSlug,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to get organization",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	updateOrganization: protectedProcedure
		.input(
			z.object({
				organizationId: z.string().optional(),
				data: z.record(z.string(), z.unknown()),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.updateOrganization({
					body: input,
					headers: context.headers as Headers,
				});

				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "UPDATE_ORGANIZATION",
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to update organization",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	deleteOrganization: protectedProcedure
		.input(
			z.object({
				organizationId: z.string(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.deleteOrganization({
					body: input,
					headers: context.headers as Headers,
				});

				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "DELETE_ORGANIZATION",
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to delete organization",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	setActiveOrganization: protectedProcedure
		.input(
			z.object({
				organizationId: z.string(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.setActiveOrganization({
					body: input,
					headers: context.headers as Headers,
				});

				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "SET_ACTIVE_ORGANIZATION",
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to set active organization",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),
	// Members
	listMembers: protectedProcedure
		.input(
			z.object({
				organizationId: z.string().optional(),
				organizationSlug: z.string().optional(),
				limit: z.number().optional(),
				offset: z.number().optional(),
				searchQuery: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.listMembers({
					query: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "LIST_MEMBERS",
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to list members",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	addMember: protectedProcedure
		.input(
			z.object({
				userId: z.string(),
				role: z.enum(["admin", "member", "owner"]),
				organizationId: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.addMember({
					body: input,
					headers: context.headers as Headers,
				});

				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "ADD_MEMBER",
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to add member",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),
	getActiveMember: protectedProcedure.handler(async ({ context }) => {
		const logger = getLogger(context);

		try {
			const result = await auth.api.getActiveMember({
				headers: context.headers as Headers,
			});
			return result;
		} catch (error) {
			logger?.error(
				{
					userId: context.session.user.id,
					action: "GET_ACTIVE_MEMBER",
					error: error instanceof Error ? error.message : "Unknown error",
				},
				"Failed to get active member",
			);
			throw mapAuthErrorToORPC(error);
		}
	}),
	updateMemberRole: protectedProcedure
		.input(
			z.object({
				memberId: z.string(),
				role: z.enum(["admin", "member", "owner"]),
				organizationId: z.string(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.updateMemberRole({
					body: input,
					headers: context.headers as Headers,
				});

				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "UPDATE_MEMBER_ROLE",
						memberId: input.memberId,
						role: input.role,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to update member role",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	removeMember: protectedProcedure
		.input(
			z.object({
				memberIdOrEmail: z.string(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.removeMember({
					body: input,
					headers: context.headers as Headers,
				});

				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "REMOVE_MEMBER",
						memberIdOrEmail: input.memberIdOrEmail,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to remove member",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	leaveOrganization: protectedProcedure
		.input(
			z.object({
				organizationId: z.string(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.leaveOrganization({
					body: input,
					headers: context.headers as Headers,
				});

				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "LEAVE_ORGANIZATION",
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to leave organization",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	// Invitations
	inviteMember: protectedProcedure
		.input(
			z.object({
				email: z.email(),
				role: z.enum(["member"]),
				organizationId: z.string(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.createInvitation({
					body: input,
					headers: context.headers as Headers,
				});

				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "INVITE_MEMBER",
						organizationId: input.organizationId,
						email: input.email,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to invite member",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	listInvitations: protectedProcedure
		.input(
			z.object({
				organizationId: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.listInvitations({
					query: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "LIST_INVITATIONS",
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to list invitations",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	cancelInvitation: protectedProcedure
		.input(
			z.object({
				invitationId: z.string(),
				organizationId: z.string(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.cancelInvitation({
					body: input,
					headers: context.headers as Headers,
				});

				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "CANCEL_INVITATION",
						invitationId: input.invitationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to cancel invitation",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	acceptInvitation: protectedProcedure
		.input(
			z.object({
				invitationId: z.string(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.acceptInvitation({
					body: input,
					headers: context.headers as Headers,
				});

				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "ACCEPT_INVITATION",
						invitationId: input.invitationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to accept invitation",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	rejectInvitation: protectedProcedure
		.input(
			z.object({
				invitationId: z.string(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.rejectInvitation({
					body: input,
					headers: context.headers as Headers,
				});

				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "REJECT_INVITATION",
						invitationId: input.invitationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to reject invitation",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	// Teams
	createTeam: protectedProcedure
		.input(
			z.object({
				name: z.string(),
				organizationId: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.createTeam({
					body: input,
					headers: context.headers as Headers,
				});

				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "CREATE_TEAM",
						teamName: input.name,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to create team",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	listTeams: protectedProcedure
		.input(
			z.object({
				organizationId: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.listOrganizationTeams({
					query: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "LIST_TEAMS",
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to list teams",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	updateTeam: protectedProcedure
		.input(
			z.object({
				teamId: z.string(),
				name: z.string().optional(),
				organizationId: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.updateTeam({
					body: {
						teamId: input.teamId,
						data: {
							...(input.name !== undefined && { name: input.name }),
							...(input.organizationId !== undefined && {
								organizationId: input.organizationId,
							}),
						},
					},
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "UPDATE_TEAM",
						teamId: input.teamId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to update team",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	removeTeam: protectedProcedure
		.input(
			z.object({
				teamId: z.string(),
				organizationId: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.removeTeam({
					body: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "REMOVE_TEAM",
						teamId: input.teamId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to remove team",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	setActiveTeam: protectedProcedure
		.input(
			z.object({
				teamId: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.setActiveTeam({
					body: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "SET_ACTIVE_TEAM",
						teamId: input.teamId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to set active team",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	listUserTeams: protectedProcedure.handler(async ({ context }) => {
		const logger = getLogger(context);

		try {
			const result = await auth.api.listUserTeams({
				headers: context.headers as Headers,
			});
			return result;
		} catch (error) {
			logger?.error(
				{
					userId: context.session.user.id,
					action: "LIST_USER_TEAMS",
					error: error instanceof Error ? error.message : "Unknown error",
				},
				"Failed to list user teams",
			);
			throw mapAuthErrorToORPC(error);
		}
	}),

	listTeamMembers: protectedProcedure
		.input(
			z.object({
				teamId: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.listTeamMembers({
					query: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "LIST_TEAM_MEMBERS",
						teamId: input.teamId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to list team members",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	addTeamMember: protectedProcedure
		.input(
			z.object({
				teamId: z.string(),
				userId: z.string(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.addTeamMember({
					body: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "ADD_TEAM_MEMBER",
						teamId: input.teamId,
						targetUserId: input.userId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to add team member",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	removeTeamMember: protectedProcedure
		.input(
			z.object({
				teamId: z.string(),
				userId: z.string(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.removeTeamMember({
					body: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "REMOVE_TEAM_MEMBER",
						teamId: input.teamId,
						targetUserId: input.userId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to remove team member",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	// Dynamic Access Control
	createRole: protectedProcedure
		.input(
			z.object({
				role: z.string(),
				permission: z.record(z.string(), z.array(z.string())),
				organizationId: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.createOrgRole({
					body: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "CREATE_ROLE",
						role: input.role,
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to create role",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	deleteRole: protectedProcedure
		.input(
			z.object({
				roleName: z.string().optional(),
				roleId: z.string().optional(),
				organizationId: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.deleteOrgRole({
					body: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "DELETE_ROLE",
						roleName: input.roleName,
						roleId: input.roleId,
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to delete role",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	listRoles: protectedProcedure
		.input(
			z.object({
				organizationId: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.listOrgRoles({
					query: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "LIST_ROLES",
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to list roles",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	getRole: protectedProcedure
		.input(
			z.object({
				roleName: z.string().optional(),
				roleId: z.string().optional(),
				organizationId: z.string().optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.getOrgRole({
					query: input,
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "GET_ROLE",
						roleName: input.roleName,
						roleId: input.roleId,
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to get role",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),

	updateRole: protectedProcedure
		.input(
			z.object({
				roleName: z.string().optional(),
				roleId: z.string().optional(),
				organizationId: z.string().optional(),
				permission: z.record(z.string(), z.array(z.string())).optional(),
			}),
		)
		.handler(async ({ input, context }) => {
			const logger = getLogger(context);

			try {
				const result = await auth.api.updateOrgRole({
					body: {
						roleName: input.roleName,
						roleId: input.roleId,
						organizationId: input.organizationId,
						data: {
							...(input.permission !== undefined && {
								permission: input.permission,
							}),
						},
					},
					headers: context.headers as Headers,
				});
				return result;
			} catch (error) {
				logger?.error(
					{
						userId: context.session.user.id,
						action: "UPDATE_ROLE",
						roleName: input.roleName,
						roleId: input.roleId,
						organizationId: input.organizationId,
						error: error instanceof Error ? error.message : "Unknown error",
					},
					"Failed to update role",
				);
				throw mapAuthErrorToORPC(error);
			}
		}),
};
